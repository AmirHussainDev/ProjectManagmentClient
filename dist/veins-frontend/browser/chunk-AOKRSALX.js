import{f as gt,g as Ve,j as yt,k as St}from"./chunk-VP57HQK5.js";import{a as Tt,b as q,c as N}from"./chunk-733G2MTE.js";import{$ as Je,$a as ze,$b as dt,A as He,Aa as P,Ac as Wt,Ba as W,Bb as Vt,Bc as qt,Ca as nt,Cb as Pt,Db as ot,Ea as Te,Eb as rt,Fa as Ot,Fb as Me,Gb as Xt,Hb as ne,Ia as Nt,Ib as ke,Jb as st,K as i,Kb as lt,L as S,Lb as mt,O as f,Ob as ie,P as r,Pb as ae,Qa as it,Qb as oe,R as xt,Rb as re,Sa as at,Sb as se,Ta as Fe,Tb as le,Va as wt,Xa as Ft,Y as o,Ya as It,Z as l,Za as X,Zb as ct,_,_a as $,_b as pt,a as $e,aa as Ke,ab as Q,ba as v,bb as H,bc as zt,ca as h,cb as J,cc as ut,da as z,db as d,dc as _t,ea as Ze,eb as Ie,ec as ft,fa as Ye,fb as K,fc as ye,ga as et,gb as Z,gc as Se,ha as D,hc as ht,ia as p,ic as Ct,ja as I,jb as Y,ka as x,kb as ee,la as fe,lc as j,ma as M,mb as Mt,mc as Lt,na as k,nb as kt,nc as me,oa as V,ob as te,oc as ce,pa as Ce,pc as Rt,qa as Ne,qc as B,ra as Et,rc as G,s as O,sa as de,sc as U,t as Qe,ta as tt,tc as pe,ua as ge,uc as At,v as Dt,va as T,vb as L,w as C,wb as R,x as g,xb as A}from"./chunk-YR6QF5UB.js";import{a as jt}from"./chunk-X5O7WZVH.js";import"./chunk-NFQMHT45.js";import{a as b,b as F,f as bt,g as y}from"./chunk-MON7YFGF.js";var cn=(s,m)=>[s,"contract",m];function pn(s,m){if(s&1&&(o(0,"tr")(1,"td",7)(2,"nz-list",8)(3,"nz-list-item")(4,"nz-list-item-meta")(5,"nz-list-item-meta-title")(6,"span",9)(7,"span"),p(8),l()()(),o(9,"nz-list-item-meta-description")(10,"span",9)(11,"span")(12,"a",10),p(13),l(),_(14,"nz-divider",11),o(15,"span",12),p(16),de(17,"date"),l()()()()()()()(),o(18,"td",13)(19,"span",14),p(20),l()()()),s&2){let a=m.$implicit,e=z();i(),r("width","80%"),i(7),fe("",a.contractor," - ",a.subject,""),i(4),r("routerLink",Et(11,cn,e.site_id,a.id)),i(),x("CR-",a.id,""),i(3),x(" ",ge(17,8,a.date_created,"dd MMM yyyy"),""),i(3),r("className",a.state===e.states.Completed?"status-chip green-button":"status-chip"),i(),x(" ",e.stateNames[a.state]," ")}}var dn=s=>[s,"contract","new"],zn=()=>({tracingId:2}),Bt=(()=>{let m=class m{constructor(e){this.appService=e,this.site_id=0,this.loading=!0,this.apiUrl=Tt.apiUrl,this.filterStates=Object.keys(Ve).map(t=>({text:Ve[t],value:t})),this.contracts=[],this.states=gt,this.stateNames=Ve}ngOnInit(){this.subOrgSubscription=this.appService.currentSubOrganization.subscribe(e=>{this.loadContractsDataFromServer()})}onContractsQueryParamsChange(e){console.log(e);let{pageSize:t,pageIndex:n,sort:c,filter:u}=e,w=c.find(_e=>_e.value!==null),E=w&&w.key||null,we=w&&w.value||null;this.loadContractsDataFromServer(n,t,E,we,u)}loadContractsDataFromServer(e=1,t=1e3,n="id",c="asc",u=[]){this.loading=!0;let w=new Nt().append("page",`${e}`).append("results",`${t}`).append("sortField",`${n}`).append("sortOrder",`${c}`);u.forEach(E=>{E.value.forEach(we=>{w=w.append(E.key,we)})}),this.getAndSetContracts(this.site_id,w)}getAndSetContracts(e,t){return y(this,null,function*(){this.contracts=yield this.appService.retireveContracts(e,t),this.loading=!1})}ngOnDestroy(){this.subOrgSubscription&&this.subOrgSubscription.unsubscribe()}};m.\u0275fac=function(t){return new(t||m)(S(N))},m.\u0275cmp=O({type:m,selectors:[["app-site-contractors"]],inputs:{site_id:"site_id"},decls:10,vars:11,consts:[[1,"contract-container"],[1,"flex","space-between",2,"margin-bottom","5px"],[3,"routerLink","state"],["nz-button","","nzType","primary",3,"nzSize"],["nz-icon","","nzType","plus"],[3,"nzShowPagination","nzData","nzFrontPagination","nzLoading","nzQueryParams"],[4,"ngFor","ngForOf"],[3,"width"],["nzItemLayout","horizontal"],[1,"flex","space-between"],["href","",3,"routerLink"],["nzType","vertical"],[1,"dateDisplay"],[2,"text-align","end"],["nz-button","",3,"className"]],template:function(t,n){t&1&&(o(0,"div",0)(1,"div",1)(2,"h3"),p(3,"Contracts"),l(),o(4,"a",2)(5,"button",3),_(6,"span",4),l()()(),o(7,"nz-table",5),h("nzQueryParams",function(u){return n.onContractsQueryParamsChange(u)}),o(8,"tbody"),f(9,pn,21,14,"tr",6),l()()()),t&2&&(i(4),r("routerLink",Ne(8,dn,n.site_id))("state",Ce(10,zn)),i(),r("nzSize","small"),i(2),r("nzShowPagination",!1)("nzData",n.contracts)("nzFrontPagination",!1)("nzLoading",n.loading),i(2),r("ngForOf",n.contracts))},dependencies:[P,Fe,A,L,R,X,mt,zt,ut,dt,ct,pt,G,j,B,U,nt],styles:[".ant-table-wrapper[_ngcontent-%COMP%]{margin:0!important}.contract-container[_ngcontent-%COMP%]{padding:12px;border-radius:12px;background:#0000001a}"]});let s=m;return s})();function _n(s,m){if(s&1&&_(0,"app-site-contractors",19),s&2){let a=z().$implicit;r("site_id",a.id)}}function fn(s,m){if(s&1){let a=v();o(0,"span",22),h("click",function(){C(a);let t=z(2).$implicit,n=z();return g(n.onExpandChange(t.id,!0))}),l()}}function hn(s,m){if(s&1){let a=v();o(0,"span",23),h("click",function(){C(a);let t=z(2).$implicit,n=z();return g(n.onExpandChange(t.id,!1))}),l()}s&2&&r("nzRotate",90)}function Cn(s,m){if(s&1&&f(0,fn,1,0,"span",20)(1,hn,1,1,"span",21),s&2){let a=z().$implicit,e=z();r("ngIf",!e.expandSet.has(a.id)),i(),r("ngIf",e.expandSet.has(a.id))}}var gn=s=>[s];function yn(s,m){if(s&1){let a=v();Je(0),o(1,"tr")(2,"td",8),h("nzExpandChange",function(t){let c=C(a).$implicit,u=z();return g(u.onExpandChange(c.id,t))}),l(),o(3,"td")(4,"nz-list",9)(5,"nz-list-item")(6,"nz-list-item-meta")(7,"nz-list-item-meta-title")(8,"span",10)(9,"span"),p(10),l(),o(11,"span"),p(12),de(13,"currency"),l()()(),o(14,"nz-list-item-meta-description")(15,"span",10)(16,"span")(17,"a",11),p(18),l(),_(19,"nz-divider",12),o(20,"span",13),p(21),de(22,"date"),l()()()()()()()(),o(23,"td",14)(24,"button",15),p(25),l()()(),o(26,"tr",16),f(27,_n,1,1,"app-site-contractors",17),l(),f(28,Cn,2,2,"ng-template",null,18,T),Ke()}if(s&2){let a=m.$implicit,e=D(29),t=z();i(),xt("expanded",t.expandSet.has(a.id)),i(),r("nzExpandIcon",e)("nzExpand",t.expandSet.has(a.id)),i(8),fe("",a.name," - ",a.subject,""),i(2),I(ge(13,18,a.amount,"PKR")),i(5),r("routerLink",Ne(24,gn,a.id)),i(),x("Site-",a.id,""),i(3),x(" ",ge(22,21,a.date_created,"dd MMM yyyy"),""),i(3),r("className",a.state===t.siteStates.Completed?"green-button":"default")("nzDanger",a.state===t.siteStates.Cancelled)("nzSize","small"),i(),x(" ",t.siteStateNames[a.state]," "),i(),xt("expanded",t.expandSet.has(a.id)),r("nzExpand",t.expandSet.has(a.id)),i(),r("ngIf",t.expandSet.has(a.id))}}var Sn=()=>["./","new"],vn=()=>({tracingId:2}),Gt=(()=>{let m=class m{onExpandChange(e,t){t?this.expandSet.add(e):this.expandSet.delete(e)}constructor(e){this.appService=e,this.siteStates=yt,this.siteStateNames=St,this.expandSet=new Set,this.listOfColumn=[{title:"id"},{title:"Name"}],this.visible=!1}ngOnInit(){this.subOrgSubscription=this.appService.currentSubOrganization.subscribe(e=>{this.populateSiteData()})}ngOnDestroy(){this.subOrgSubscription&&this.subOrgSubscription.unsubscribe()}open(){this.visible=!0}close(e=!1){this.visible=!1,e&&this.populateSiteData()}populateSiteData(){return y(this,null,function*(){this.sites=yield this.appService.getSites()})}};m.\u0275fac=function(t){return new(t||m)(S(N))},m.\u0275cmp=O({type:m,selectors:[["app-sites"]],decls:14,vars:10,consts:[[3,"routerLink","state"],["nz-button","","nzType","primary",3,"nzSize"],["nz-icon","","nzType","plus"],[3,"nzShowPagination","nzData","nzFrontPagination"],["nzWidth","60px"],["nzColumnKey","name","nzWidth","80%",3,"nzSortFn"],["nzColumnKey","gender"],[4,"ngFor","ngForOf"],[3,"nzExpandIcon","nzExpand","nzExpandChange"],["nzItemLayout","horizontal"],[1,"flex","space-between"],["href","",3,"routerLink"],["nzType","vertical"],[1,"dateDisplay"],[2,"text-align","end"],["nz-button","","nzType","primary","nzShape","round",3,"className","nzDanger","nzSize"],[1,"expanded-table",3,"nzExpand"],[3,"site_id",4,"ngIf"],["expandIcon",""],[3,"site_id"],["nz-icon","","nzType","double-right","nzTheme","outline","style","font-size: 16px; color: #08c;",3,"click",4,"ngIf"],["nz-icon","","nzType","double-right","nzTheme","outline","style","font-size: 16px; color: #08c;",3,"nzRotate","click",4,"ngIf"],["nz-icon","","nzType","double-right","nzTheme","outline",2,"font-size","16px","color","#08c",3,"click"],["nz-icon","","nzType","double-right","nzTheme","outline",2,"font-size","16px","color","#08c",3,"nzRotate","click"]],template:function(t,n){t&1&&(o(0,"a",0)(1,"button",1),_(2,"span",2),p(3," New Site "),l()(),o(4,"nz-table",3)(5,"thead")(6,"tr"),_(7,"th",4),o(8,"th",5),p(9,"Site"),l(),o(10,"th",6),p(11,"Status"),l()()(),o(12,"tbody"),f(13,yn,30,26,"ng-container",7),l()()),t&2&&(r("routerLink",Ce(8,Sn))("state",Ce(9,vn)),i(),r("nzSize","small"),i(3),r("nzShowPagination",!1)("nzData",n.sites)("nzFrontPagination",!1),i(4),r("nzSortFn",!0),i(5),r("ngForOf",n.sites))},dependencies:[P,W,Fe,A,L,R,X,mt,zt,ut,dt,ct,pt,G,me,j,ce,Lt,pe,B,U,At,Rt,Bt,Te,nt],styles:[".expanded-table[_ngcontent-%COMP%] > td[_ngcontent-%COMP%]{background:transparent!important}  .expanded{background:#ffffffb8}"]});let s=m;return s})();var Jt=bt(jt());function xn(s,m){if(s&1&&(o(0,"nz-col",12)(1,"nz-form-item")(2,"nz-form-label",20),p(3,"No of units worked"),l(),o(4,"nz-form-control",14),p(5),l()()()),s&2){let a=z(2),e;r("nzMd",10)("nzSm",16)("nzXs",16),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(),x(" ",(e=a.addContractorWorkLogForm.get("no_of_units"))==null?null:e.value," ")}}var wn=()=>({standalone:!0});function bn(s,m){if(s&1){let a=v();o(0,"nz-card",9)(1,"form",10),h("ngSubmit",function(){C(a);let t=z();return g(t.handleOk())}),o(2,"nz-row",11)(3,"nz-col",12)(4,"nz-form-item")(5,"nz-form-label",13),p(6,"From"),l(),o(7,"nz-form-control",14)(8,"nz-range-picker",15),V("ngModelChange",function(t){C(a);let n=z();return k(n.date,t)||(n.date=t),g(t)}),h("ngModelChange",function(t){C(a);let n=z();return g(n.onChange(t))}),l()()()(),f(9,xn,6,9,"nz-col",16),l(),o(10,"nz-row",11)(11,"nz-col",12)(12,"nz-form-item")(13,"nz-form-label",17),p(14,"WorkLog Notes"),l(),o(15,"nz-form-control",18),_(16,"textarea",19),l()()()()()()}if(s&2){let a=z();i(),r("formGroup",a.addContractorWorkLogForm),i(2),r("nzMd",10)("nzSm",24)("nzXs",24),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(),r("ngModelOptions",Ce(20,wn)),M("ngModel",a.date),i(),r("ngIf",a.contractDetails.contract_type=="1"),i(2),r("nzMd",24)("nzSm",24)("nzXs",24),i(2),r("nzMd",8)("nzSm",24)("nzXs",24),i(2),r("nzSm",14)("nzXs",24)}}function Dn(s,m){if(s&1){let a=v();o(0,"div",21),_(1,"input",22,23),o(3,"a",24),h("click",function(){C(a);let t=D(2),n=z();return g(n.addItem(t))}),_(4,"span",25),p(5," Add item "),l()()}}function En(s,m){if(s&1&&(o(0,"th",26),p(1),l()),s&2){let a=m.$implicit;r("nzSortFn",a.compare)("nzSortPriority",a.priority),i(),x(" ",a.title," ")}}function On(s,m){if(s&1&&(o(0,"tr")(1,"td"),p(2),l(),o(3,"td"),p(4),l(),o(5,"td"),p(6),l()()),s&2){let a=m.$implicit;i(2),x(" ",a.note,""),i(2),I(a.amount),i(2),x(" ",a.no_of_units," ")}}var $t=(()=>{let m=class m{constructor(e,t,n){this.appService=e,this.userService=t,this.fb=n,this.vendorItems=[],this.listOfColumn=[{title:"Note",compare:(c,u)=>c.note.localeCompare(u.note),priority:!1},{title:"Amount",compare:(c,u)=>c.amount-u.amount,priority:2},{title:"No Of Units",compare:(c,u)=>(c.no_of_units?1:0)-(u.no_of_units?1:0),priority:2}],this.listOfData=[],this.visible=!1,this.isVisible=!1,this.isOkLoading=!1,this.index=0,this.editCache={}}showModal(){this.isVisible=!0}handleOk(){return y(this,null,function*(){try{this.isOkLoading=!0,yield this.addContractorWorkLog(),this.isVisible=!1,this.addContractorWorkLogForm.reset()}catch{}finally{this.isOkLoading=!1,this.populateContractorWorkLogData()}})}addContractorWorkLog(){return y(this,null,function*(){this.subOrganizations=yield this.appService.saveSiteContractorWorkLog(F(b({},this.addContractorWorkLogForm.getRawValue()),{site:this.site_id}))})}handleCancel(){this.isVisible=!1}ngOnInit(){this.addContractorWorkLogForm=new J({id:new d(0),amount:new d(0,[ze.required]),note:new d,work_from:new d(new Date),work_to:new d(new Date),no_of_units:new d(0),contract:new d(this.contractDetails.id),site:new d(this.site_id)}),this.populateContractorWorkLogData()}open(){this.visible=!0}close(e=!1){this.visible=!1,e&&this.populateContractorWorkLogData()}populateContractorWorkLogData(){return y(this,null,function*(){this.listOfData=yield this.appService.retrieveSiteContractWorkLogBySiteId(this.site_id,this.contractDetails.id),this.updateEditCache()})}addItem(e){let t=e.value;this.vendorItems.some(n=>!t||n.name===t.trim())||(this.vendorItems=[...this.vendorItems,{name:e.value,isCustom:!0}],e.value="")}onChange(e){if(e&&e.length>1){let t=this.getNumberOfDays(e[0],e[1],this.contractDetails.includeWeekends);this.addContractorWorkLogForm.patchValue({work_from:e[0],work_to:e[1],no_of_units:t,amount:t*this.contractDetails.amount_per_day})}}getNumberOfDays(e,t,n=!1){let c=new Date(e),u=Math.ceil((t.getTime()-e.getTime())/(1e3*3600*24)),w=0;for(let E=0;E<=u;E++){if(!n&&(c.getDay()===0||c.getDay()===6)){c.setDate(c.getDate()+1);continue}w++,c.setDate(c.getDate()+1)}return w}startEdit(e){this.editCache[e].edit=!0}cancelEdit(e){let t=this.listOfData.findIndex(n=>n.id===e);this.editCache[e]={data:b({},this.listOfData[t]),edit:!1}}saveEdit(e){return y(this,null,function*(){let t=this.listOfData.findIndex(n=>n.id===e);this.editCache[e].edit=!1,Object.assign(this.listOfData[t],this.editCache[e].data),this.populateContractorWorkLogData()})}updateEditCache(){this.listOfData.forEach(e=>{this.editCache[e.id]={edit:!1,data:b({},e)}})}};m.\u0275fac=function(t){return new(t||m)(S(N),S(q),S(ee))},m.\u0275cmp=O({type:m,selectors:[["app-work-log"]],inputs:{contractDetails:"contractDetails",site_id:"site_id"},decls:18,vars:6,consts:[[1,"flex","center","space-between"],["nz-button","","nzType","primary",3,"click"],["nzTitle","Add Work Log",3,"nzVisible","nzOkDisabled","nzOkLoading","nzVisibleChange","nzOnCancel","nzOnOk"],["style","width:100%",4,"nzModalContent"],["renderTemplate",""],["nzShowPagination","false","nzTableLayout","fixed",3,"nzData"],["editRowTable","","sortTable",""],[3,"nzSortFn","nzSortPriority",4,"ngFor","ngForOf"],[4,"ngFor","ngForOf"],[2,"width","100%"],["nz-form","",3,"formGroup","ngSubmit"],["nzGutter","2",2,"margin-bottom","12px"],[3,"nzMd","nzSm","nzXs"],["nzRequired","","nzFor","from",3,"nzMd","nzSm","nzXs"],["nzErrorTip","The input is not valid date!",3,"nzSm","nzXs"],[3,"ngModelOptions","ngModel","ngModelChange"],[3,"nzMd","nzSm","nzXs",4,"ngIf"],["nzRequired","","nzFor","name",3,"nzMd","nzSm","nzXs"],["nzErrorTip","The input is not valid date!",1,"flex","space-between","center",3,"nzSm","nzXs"],["nz-input","","formControlName","note",1,"control","inputField"],["nzRequired","","nzFor","no_of_units",3,"nzMd","nzSm","nzXs"],[1,"container"],["type","text","nz-input",""],["inputElement",""],[1,"add-item",3,"click"],["nz-icon","","nzType","plus"],[3,"nzSortFn","nzSortPriority"]],template:function(t,n){if(t&1&&(o(0,"div",0)(1,"h3"),p(2,"Work Log"),l(),o(3,"button",1),h("click",function(){return n.showModal()}),o(4,"span"),p(5,"Add Work Log"),l()()(),o(6,"nz-modal",2),V("nzVisibleChange",function(u){return k(n.isVisible,u)||(n.isVisible=u),u}),h("nzOnCancel",function(){return n.handleCancel()})("nzOnOk",function(){return n.handleOk()}),f(7,bn,17,21,"nz-card",3),l(),f(8,Dn,6,0,"ng-template",null,4,T),o(10,"nz-table",5,6)(13,"thead")(14,"tr"),f(15,En,2,3,"th",7),l()(),o(16,"tbody"),f(17,On,7,3,"tr",8),l()()),t&2){let c=D(12);i(6),M("nzVisible",n.isVisible),r("nzOkDisabled",n.addContractorWorkLogForm.invalid)("nzOkLoading",n.isOkLoading),i(4),r("nzData",n.listOfData),i(5),r("ngForOf",n.listOfColumn),i(2),r("ngForOf",c.data)}},dependencies:[P,W,A,L,R,ne,X,Me,Xt,ae,ie,re,oe,le,se,te,Se,ye,G,me,j,ce,pe,B,U,K,$,Q,H,Z,Y,Ie]});let s=m;return s})();function Tn(s,m){s&1&&(o(0,"nz-col",13)(1,"nz-form-item")(2,"nz-form-label",17),p(3,"Amount "),l(),o(4,"nz-form-control",18),_(5,"input",19),l()()()),s&2&&(r("nzMd",10)("nzSm",16)("nzXs",16),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24))}function Fn(s,m){if(s&1){let a=v();o(0,"nz-card",9)(1,"form",10),h("ngSubmit",function(){C(a);let t=z();return g(t.handleOk())}),o(2,"nz-row",11),f(3,Tn,6,8,"nz-col",12),l(),o(4,"nz-row",11)(5,"nz-col",13)(6,"nz-form-item")(7,"nz-form-label",14),p(8,"Payment Notes"),l(),o(9,"nz-form-control",15),_(10,"textarea",16),l()()()()()()}if(s&2){let a=z();i(),r("formGroup",a.addContractorPaymentForm),i(2),r("ngIf",a.contractDetails.contract_type=="1"),i(2),r("nzMd",24)("nzSm",24)("nzXs",24),i(2),r("nzMd",8)("nzSm",24)("nzXs",24),i(2),r("nzSm",14)("nzXs",24)}}function In(s,m){if(s&1){let a=v();o(0,"div",20),_(1,"input",21,22),o(3,"a",23),h("click",function(){C(a);let t=D(2),n=z();return g(n.addItem(t))}),_(4,"span",24),p(5," Add item "),l()()}}function Mn(s,m){if(s&1&&(o(0,"th",25),p(1),l()),s&2){let a=m.$implicit;r("nzSortFn",a.compare)("nzSortPriority",a.priority),i(),x(" ",a.title," ")}}function kn(s,m){if(s&1&&(o(0,"tr")(1,"td"),p(2),l(),o(3,"td"),p(4),l()()),s&2){let a=m.$implicit;i(2),x(" ",a.note,""),i(2),I(a.amount)}}var Qt=(()=>{let m=class m{constructor(e,t,n){this.appService=e,this.userService=t,this.fb=n,this.vendorItems=[],this.listOfColumn=[{title:"Note",compare:(c,u)=>c.note.localeCompare(u.note),priority:!1},{title:"Amount",compare:(c,u)=>c.amount-u.amount,priority:2}],this.listOfData=[],this.visible=!1,this.isVisible=!1,this.isOkLoading=!1,this.index=0,this.editCache={}}showModal(){this.isVisible=!0}handleOk(){return y(this,null,function*(){try{this.isOkLoading=!0,yield this.addContractorPayment(),this.isVisible=!1,this.addContractorPaymentForm.reset()}catch{}finally{this.isOkLoading=!1,this.populateContractorPaymentData()}})}addContractorPayment(){return y(this,null,function*(){this.subOrganizations=yield this.appService.saveSiteContractorPayment(F(b({},this.addContractorPaymentForm.getRawValue()),{site:this.site_id}))})}handleCancel(){this.isVisible=!1}ngOnInit(){this.addContractorPaymentForm=new J({id:new d(0),amount:new d(0,[ze.required]),note:new d,contract:new d(this.contractDetails.id),site:new d(this.site_id)}),this.populateContractorPaymentData()}open(){this.visible=!0}close(e=!1){this.visible=!1,e&&this.populateContractorPaymentData()}populateContractorPaymentData(){return y(this,null,function*(){this.listOfData=yield this.appService.retrieveSiteContractPaymentBySiteId(this.site_id,this.contractDetails.id),this.updateEditCache()})}addItem(e){let t=e.value;this.vendorItems.some(n=>!t||n.name===t.trim())||(this.vendorItems=[...this.vendorItems,{name:e.value,isCustom:!0}],e.value="")}getNumberOfDays(e,t,n=!1){let c=new Date(e),u=Math.ceil((t.getTime()-e.getTime())/(1e3*3600*24)),w=0;for(let E=0;E<=u;E++){if(!n&&(c.getDay()===0||c.getDay()===6)){c.setDate(c.getDate()+1);continue}w++,c.setDate(c.getDate()+1)}return w}startEdit(e){this.editCache[e].edit=!0}cancelEdit(e){let t=this.listOfData.findIndex(n=>n.id===e);this.editCache[e]={data:b({},this.listOfData[t]),edit:!1}}saveEdit(e){return y(this,null,function*(){let t=this.listOfData.findIndex(n=>n.id===e);this.editCache[e].edit=!1,Object.assign(this.listOfData[t],this.editCache[e].data),this.populateContractorPaymentData()})}updateEditCache(){this.listOfData.forEach(e=>{this.editCache[e.id]={edit:!1,data:b({},e)}})}};m.\u0275fac=function(t){return new(t||m)(S(N),S(q),S(ee))},m.\u0275cmp=O({type:m,selectors:[["app-contract-payment"]],inputs:{contractDetails:"contractDetails",site_id:"site_id"},decls:18,vars:6,consts:[[1,"flex","center","space-between"],["nz-button","","nzType","primary",3,"click"],["nzTitle","Add Contractor Payment",3,"nzVisible","nzOkDisabled","nzOkLoading","nzVisibleChange","nzOnCancel","nzOnOk"],["style","width:100%",4,"nzModalContent"],["renderTemplate",""],["nzShowPagination","false","nzTableLayout","fixed",3,"nzData"],["editRowTable","","sortTable",""],[3,"nzSortFn","nzSortPriority",4,"ngFor","ngForOf"],[4,"ngFor","ngForOf"],[2,"width","100%"],["nz-form","",3,"formGroup","ngSubmit"],["nzGutter","2",2,"margin-bottom","12px"],[3,"nzMd","nzSm","nzXs",4,"ngIf"],[3,"nzMd","nzSm","nzXs"],["nzRequired","","nzFor","name",3,"nzMd","nzSm","nzXs"],["nzErrorTip","The input is not valid date!",1,"flex","space-between","center",3,"nzSm","nzXs"],["nz-input","","formControlName","note",1,"control","inputField"],["nzRequired","","nzFor","amount",3,"nzMd","nzSm","nzXs"],["nzErrorTip","The input is not valid date!",3,"nzSm","nzXs"],["nz-input","","formControlName","amount"],[1,"container"],["type","text","nz-input",""],["inputElement",""],[1,"add-item",3,"click"],["nz-icon","","nzType","plus"],[3,"nzSortFn","nzSortPriority"]],template:function(t,n){if(t&1&&(o(0,"div",0)(1,"h3"),p(2,"Payments"),l(),o(3,"button",1),h("click",function(){return n.showModal()}),o(4,"span"),p(5,"Add Payment"),l()()(),o(6,"nz-modal",2),V("nzVisibleChange",function(u){return k(n.isVisible,u)||(n.isVisible=u),u}),h("nzOnCancel",function(){return n.handleCancel()})("nzOnOk",function(){return n.handleOk()}),f(7,Fn,11,10,"nz-card",3),l(),f(8,In,6,0,"ng-template",null,4,T),o(10,"nz-table",5,6)(13,"thead")(14,"tr"),f(15,Mn,2,3,"th",7),l()(),o(16,"tbody"),f(17,kn,5,2,"tr",8),l()()),t&2){let c=D(12);i(6),M("nzVisible",n.isVisible),r("nzOkDisabled",n.addContractorPaymentForm.invalid)("nzOkLoading",n.isOkLoading),i(4),r("nzData",n.listOfData),i(5),r("ngForOf",n.listOfColumn),i(2),r("ngForOf",c.data)}},dependencies:[P,W,A,L,R,ne,X,ae,ie,re,oe,le,se,te,Se,ye,G,me,j,ce,pe,B,U,K,$,Q,H,Z,Y]});let s=m;return s})();var An=["content"];function Wn(s,m){if(s&1){let a=v();o(0,"div",39)(1,"span")(2,"h4"),p(3),l()(),o(4,"span")(5,"button",40),h("click",function(){C(a);let t=z();return g(t.generatePDF())}),_(6,"span",41),l(),o(7,"button",42),_(8,"span",43),l()()()}if(s&2){let a=z(),e;i(3),fe(" Contract - ",((e=a.contractDetails.get("id"))==null?null:e.value)||"New"," / ",a.stateNames[(e=a.contractDetails.get("state"))==null?null:e.value]," ")}}function qn(s,m){if(s&1&&_(0,"nz-option",44),s&2){let a=m.$implicit;r("nzValue",a==null?null:a.id)("nzLabel",a==null?null:a.name)}}var jn=()=>({authorization:"authorization-text"});function Bn(s,m){if(s&1){let a=v();o(0,"nz-card",45)(1,"nz-form-item")(2,"nz-form-label",46),p(3,"Terms & Conditions"),l(),o(4,"nz-form-control",47),_(5,"textarea",48),l()(),o(6,"nz-form-item")(7,"nz-form-label",49),p(8,"Attachments"),l(),o(9,"nz-form-control",50)(10,"nz-upload",51),h("nzChange",function(t){C(a);let n=z();return g(n.handleChange(t))}),o(11,"button",52),_(12,"span",53),p(13," Click to Upload "),l()()()()()}s&2&&(i(4),r("nzMd",8)("nzSm",24)("nzXs",12)("nzMd",24)("nzXl",24)("nzXXl",24),i(5),r("nzMd",8)("nzSm",24)("nzXs",12)("nzMd",24)("nzXl",24)("nzXXl",24),i(),r("nzHeaders",Ce(13,jn)))}function Gn(s,m){if(s&1){let a=v();o(0,"button",54),h("click",function(){C(a);let t=z();return g(t.cancelPaymentDetails())}),p(1,"Cancel"),l()}}function Un(s,m){if(s&1){let a=v();o(0,"button",55),h("click",function(){C(a);let t=z();return g(t.submitRequest())}),p(1,"Submit"),l()}}function $n(s,m){if(s&1){let a=v();o(0,"button",55),h("click",function(){C(a);let t=z();return g(t.confirmInvoiceDetails())}),p(1,"Confirm Contract"),l()}}function Qn(s,m){if(s&1&&(p(0),_(1,"span",56)),s&2){let a=m.$implicit;z();let e=D(4);x(" ",a," "),i(),r("nzRotate",e.nzActive?90:-90)}}function Hn(s,m){if(s&1&&(o(0,"div",57)(1,"nz-row",58)(2,"nz-col",9)(3,"nz-card",5),_(4,"app-work-log",59),l()(),o(5,"nz-col",9)(6,"nz-card",5),_(7,"app-contract-payment",59),l()()()()),s&2){let a=z();i(2),r("nzMd",12)("nzSm",24)("nzXs",24),i(2),r("site_id",a.site_id)("contractDetails",a.contractDetails.getRawValue()),i(),r("nzMd",12)("nzSm",24)("nzXs",24),i(2),r("site_id",a.site_id)("contractDetails",a.contractDetails.getRawValue())}}var Kt=(()=>{let m=class m{constructor(e,t,n,c,u,w,E,we){this.appService=e,this.route=t,this.userService=n,this.fb=c,this.notification=u,this.router=w,this.msg=E,this.modal=we,this.isActive=!1,this.vendors=[],this.vendorItems=[],this.discountTotal=0,this.contractTotal=0,this.loading=!1,this.contractStates=gt,this.stateNames=Ve,this.site_id=0,this.listOfData=[],this.defaultItemValues={id:0,name:"",qty:0,contract_id:0,discount:0,total:0,date_created:new Date,isCustom:!1,unit_price:0},this.contractDetails=new J({id:new d,contractor:new d,subject:new d,contract_type:new d,state:new d(this.contractStates.Draft),with_material:new d(0),payment_schedule:new d(0),amount_per_schedule:new d(0),amount_per_day:new d(0),created_by:new d(0),site:new d(0),total:new d(0),organization:new d(0),subOrganization:new d(0),contract_start_date:new d(new Date),contract_end_date:new d(new Date),attachment:new d,terms:new d("")}),this.beforeUpload=(_e,sn)=>new $e(he=>{let Re=_e.type==="image/jpeg"||_e.type==="image/png";if(!Re){this.msg.error("You can only upload JPG file!"),he.complete();return}let Ae=_e.size/1024/1024<2;if(!Ae){this.msg.error("Image must smaller than 2MB!"),he.complete();return}this.contractDetails.patchValue({attachment:_e}),he.next(Re&&Ae),he.complete()}),this.contractDetails=this.fb.group({id:new d,contractor:new d,subject:new d,contract_type:new d,state:new d(this.contractStates.Draft),with_material:new d(0),payment_schedule:new d(0),amount_per_schedule:new d(0),amount_per_day:new d(0),created_by:new d(0),site:new d(0),total:new d(0),organization:new d(0),subOrganization:new d(0),contract_start_date:new d(new Date),contract_end_date:new d(new Date),attachment:new d,terms:new d("")})}submitForm(){}ngOnInit(){this.loadAndUsers(),this.setSitesData(),this.route.paramMap.subscribe(e=>{e.get("contractId")||(this.contractDetails.reset({state:this.contractStates.Draft,id:0}),this.contractDetails.enable(),this.contractDetails.updateValueAndValidity()),this.site_id=parseInt(e.get("siteId")?.toString()||"0"),this.contractDetails.controls.id.setValue(e.get("contractId")!=="new"?e.get("contractId"):0),this.contractDetails.controls.site.setValue(e.get("siteId")||0),this.setContractRequestDetails()})}setSitesData(){return y(this,null,function*(){let e=yield this.appService.getAndSetSites(),t=e&&e.length?e.map(n=>b({label:n.name},n)):[];this.sites=[...t]})}setContractRequestDetails(){return y(this,null,function*(){this.loading=!0,this.contractDetails.controls.id.value?yield this.getExistingContract():(this.contractDetails.controls.organization.setValue(parseInt(localStorage.getItem("organization_id")||"")),this.currentSubOrganizationSubscription=this.appService.currentSubOrganization.subscribe(e=>{this.contractDetails.controls.subOrganization.setValue(e.id)}),this.contractDetails.controls.created_by.setValue(this.userService.loggedInUser.id)),this.disableAndEnableSpecificControls(),this.loading=!1})}getExistingContract(){return y(this,null,function*(){let e=yield this.appService.retireveContractById(this.contractDetails.controls.site.value,this.contractDetails.controls.id.value);e&&this.contractDetails.patchValue({id:e.id,subject:e.subject,state:e.state,created_by:e.created_by,total:e.total,organization:e.organization_id,subOrganization:e.sub_organization_id,contractor:e.contractor,contract_type:e.contract_type,with_material:e.with_material,payment_schedule:e.payment_schedule,amount_per_schedule:e.amount_per_schedule,amount_per_day:e.amount_per_day,site:e.site_id,contract_start_date:e.contract_start_date,contract_end_date:e.contract_end_date,attachment:e.attachment,terms:e.terms}),this.previousContractDetails=this.contractDetails.getRawValue()})}loadAndUsers(){return y(this,null,function*(){this.listOfData=yield this.userService.getOrganizationUsers()})}submitRequest(){return y(this,null,function*(){let e=yield this.appService.createContract(F(b({},this.contractDetails.value),{state:this.contractStates.PendingApproval}));e&&this.notification.create("success","Contract Order - "+e.id,"Contract order submitted successfly. Please check for invoice and update later").onClose.subscribe(t=>{this.router.navigate(["/"])})})}cancelPaymentDetails(){return y(this,null,function*(){})}confirmInvoiceDetails(){return y(this,null,function*(){let e=this.appService.findObjectDifferences(this.previousContractDetails,this.contractDetails.getRawValue());console.log(e);let t=b({id:this.previousContractDetails.id},e);(yield this.appService.updateContractRequest(F(b({},t),{state:this.contractStates.Completed})))&&this.notification.create("success","Contract Order - "+this.previousContractDetails.id,"Contract order invoice submitted successfly. Please proceed next for payment details").onClose.subscribe(c=>{this.router.navigate(["/"])})})}printCard(){let e=this.content.nativeElement.innerHTML,t=window.open("","_blank","top=0,left=0,height=100%,width=auto");t&&(t.document.open(),t.document.write(`
      <html>
        <head>
          <title>Print</title>
          <style>
            /* Define print styles here */
          </style>
        </head>
        <body onload="window.print();window.close()">
          ${e}
        </body>
      </html>
    `),t.print())}generatePDF(){let e=this.content.nativeElement;(0,Jt.default)(e).then(t=>{let n=t.toDataURL("image/png")})}disableAndEnableSpecificControls(){let e=this.contractDetails.get("state");e&&e.value!==this.contractStates.Draft&&(console.log(this.contractDetails),Object.keys(this.contractDetails.controls).forEach(t=>{let n=this.contractDetails.get(t);n&&(t!=="attachment"&&t!=="terms"&&e.value===this.contractStates.PendingApproval||e.value===this.contractStates.Completed)&&n.disable()}),console.log(this.contractDetails),this.contractDetails.updateValueAndValidity())}getBase64(e,t){let n=new FileReader;n.addEventListener("load",()=>t(n.result.toString())),n.readAsDataURL(e)}handleChange(e){this.getBase64(e.file.originFileObj,t=>{this.loading=!1})}};m.\u0275fac=function(t){return new(t||m)(S(N),S(it),S(q),S(ee),S(ht),S(at),S(_t),S(ft))},m.\u0275cmp=O({type:m,selectors:[["app-site-contract"]],viewQuery:function(t,n){if(t&1&&Ze(An,5),t&2){let c;Ye(c=et())&&(n.content=c.first)}},decls:80,vars:74,consts:[["renderHome",""],["nzAccordion",""],["nzExpandedIcon","double-right",3,"nzHeader","nzActive","nzDisabled"],["p",""],["id","print-section",1,"purchase-request"],[2,"width","100%"],["nz-form","",3,"formGroup","ngSubmit"],["content",""],["nzGutter","2",2,"margin-bottom","12px"],[3,"nzMd","nzSm","nzXs"],["nzRequired","","nzFor","contract_type",3,"nzMd","nzSm","nzXs"],["nzErrorTip","The input is not valid date!",3,"nzSm","nzXs"],["zShowSearch","","nzAllowClear","","nzPlaceHolder","Select a person","formControlName","contract_type",1,"control","inputField"],["nzLabel","Duration Based","nzValue","1"],["nzLabel","Measurement Based","nzValue","2"],["nzRequired","","nzFor","with_material"],["nzErrorTip","The input is not valid date!"],["nz-checkbox","","formControlName","with_material"],["nzRequired","","nzFor","contractor",3,"nzMd","nzSm","nzXs"],["d","contractor","formControlName","contractor","placeholder","Select user",1,"control","inputField"],[3,"nzValue","nzLabel",4,"ngFor","ngForOf"],["nzRequired","","nzFor","contract_start_date",3,"nzMd","nzSm","nzXs"],["formControlName","contract_start_date",1,"control","inputField"],["nzRequired","","nzFor","contract_end_date",3,"nzMd","nzSm","nzXs"],["formControlName","contract_end_date",1,"control","inputField"],["nzRequired","","nzFor","payment_schedule",3,"nzMd","nzSm","nzXs"],["nz-input","","formControlName","payment_schedule",1,"control","inputField"],["nzRequired","","nzFor","subject",3,"nzMd","nzSm","nzXs"],["z-input","","formControlName","subject",1,"control","inputField"],["nzRequired","","nzFor","amount_per_schedule",3,"nzMd","nzSm","nzXs"],["z-input","","formControlName","amount_per_schedule",1,"control","inputField"],["nzRequired","","nzFor","amount_per_day",3,"nzMd","nzSm","nzXs"],["z-input","","formControlName","amount_per_day",1,"control","inputField"],["style","width:100%;margin-bottom: 12px;",4,"ngIf"],[1,"flex","space-between"],["nz-button","","nzType","primary","nzDanger","","style","margin-bottom: 12px;float: right;",3,"click",4,"ngIf"],["nz-button","","nzType","primary","style","margin-bottom: 12px;float: right;",3,"click",4,"ngIf"],["expandedIcon",""],["style","margin-top: 12px;",4,"ngIf"],[1,"detailBar-collapsible"],["nz-button","","nzType","primary",3,"click"],["nz-icon","","nzType","download"],["nz-button","","nzType","primary","printSectionId","print-section","ngxPrint","","printTitle","MyTitle",2,"margin-left","12px"],["nz-icon","","nzType","printer","nzTheme","outline"],[3,"nzValue","nzLabel"],[2,"width","100%","margin-bottom","12px"],["nzFor","terms"],["nzErrorTip","",3,"nzMd","nzSm","nzXs","nzXl","nzXXl"],["nz-input","","formControlName","terms","placeholder","textarea with clear icon"],["nzRequired","","nzFor","contract_start_date"],["nzErrorTip","The input is not valid date!",3,"nzMd","nzSm","nzXs","nzXl","nzXXl"],["nzAction","https://www.mocky.io/v2/5cc8019d300000980a055e76",3,"nzHeaders","nzChange"],["nz-button",""],["nz-icon","","nzType","upload"],["nz-button","","nzType","primary","nzDanger","",2,"margin-bottom","12px","float","right",3,"click"],["nz-button","","nzType","primary",2,"margin-bottom","12px","float","right",3,"click"],["nz-icon","","nzType","caret-right",1,"ant-collapse-arrow",3,"nzRotate"],[2,"margin-top","12px"],["nzGutter","4",2,"margin-bottom","12px"],[3,"site_id","contractDetails"]],template:function(t,n){if(t&1&&(f(0,Wn,9,2,"ng-template",null,0,T),o(2,"nz-collapse",1)(3,"nz-collapse-panel",2,3)(5,"div",4)(6,"nz-card",5)(7,"form",6),h("ngSubmit",function(){return n.submitForm()}),o(8,"div",null,7)(10,"nz-row",8)(11,"nz-col",9)(12,"nz-form-item")(13,"nz-form-label",10),p(14,"Contract Type"),l(),o(15,"nz-form-control",11)(16,"nz-select",12),_(17,"nz-option",13)(18,"nz-option",14),l()()()(),o(19,"nz-col",9)(20,"nz-form-item")(21,"nz-form-label",15),p(22,"with_material"),l(),o(23,"nz-form-control",16),_(24,"label",17),l()()()(),o(25,"nz-row",8)(26,"nz-col",9)(27,"nz-form-item")(28,"nz-form-label",18),p(29,"Contractor"),l(),o(30,"nz-form-control",11)(31,"nz-select",19),f(32,qn,1,2,"nz-option",20),l()()()(),o(33,"nz-col",9)(34,"nz-form-item")(35,"nz-form-label",21),p(36,"contract_start_date"),l(),o(37,"nz-form-control",11),_(38,"nz-date-picker",22),l()()()(),o(39,"nz-row",8)(40,"nz-col",9)(41,"nz-form-item")(42,"nz-form-label",23),p(43,"contract_end_date"),l(),o(44,"nz-form-control",11),_(45,"nz-date-picker",24),l()()(),o(46,"nz-col",9)(47,"nz-form-item")(48,"nz-form-label",25),p(49,"payment_schedule"),l(),o(50,"nz-form-control",11),_(51,"input",26),l()()()(),o(52,"nz-row",8)(53,"nz-col",9)(54,"nz-form-item")(55,"nz-form-label",27),p(56,"Subject"),l(),o(57,"nz-form-control",11),_(58,"input",28),l()()(),o(59,"nz-col",9)(60,"nz-form-item")(61,"nz-form-label",29),p(62,"amount_per_schedule"),l(),o(63,"nz-form-control",11),_(64,"input",30),l()()()(),o(65,"nz-form-item")(66,"nz-form-label",31),p(67,"amount_per_day"),l(),o(68,"nz-form-control",11),_(69,"input",32),l()(),f(70,Bn,14,14,"nz-card",33),l(),o(71,"span",34)(72,"span"),f(73,Gn,2,0,"button",35),l(),o(74,"span"),f(75,Un,2,0,"button",36)(76,$n,2,0,"button",36),l()()()()(),f(77,Qn,2,2,"ng-template",null,37,T),l()(),f(79,Hn,8,10,"div",38)),t&2){let c=D(1),u,w,E;i(3),r("nzHeader",c)("nzActive",n.isActive||((u=n.contractDetails.get("state"))==null?null:u.value)!==n.contractStates.Approved&&((u=n.contractDetails.get("state"))==null?null:u.value)!==n.contractStates.Completed)("nzDisabled",((w=n.contractDetails.get("state"))==null?null:w.value)!==n.contractStates.Approved&&((w=n.contractDetails.get("state"))==null?null:w.value)!==n.contractStates.Completed),i(4),r("formGroup",n.contractDetails),i(4),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(4),r("nzMd",4)("nzSm",24)("nzXs",12),i(7),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(2),r("ngForOf",n.listOfData),i(),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(3),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(2),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(3),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(2),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(3),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(2),r("ngIf",n.contractDetails.controls.state.value!==n.contractStates.Draft),i(3),r("ngIf",n.contractDetails.controls.state.value==n.contractStates.PendingApproval),i(2),r("ngIf",n.contractDetails.controls.state.value==n.contractStates.Draft),i(),r("ngIf",n.contractDetails.controls.state.value==n.contractStates.PendingApproval),i(3),r("ngIf",((E=n.contractDetails.get("state"))==null?null:E.value)===n.contractStates.Completed)}},dependencies:[P,W,A,L,R,ne,ke,lt,st,X,Me,ae,ie,re,oe,le,se,te,ot,rt,Wt,K,$,Q,H,Z,Y,$t,Qt]});let s=m;return s})();var nn=bt(jt());var Le=(()=>{let m=class m{constructor(e){this.userService=e}transform(e,...t){let n=this.userService.users.find(c=>c.id==e);return n?n.name:e}};m.\u0275fac=function(t){return new(t||m)(S(q,16))},m.\u0275pipe=Dt({name:"username",type:m,pure:!0,standalone:!0});let s=m;return s})();function Kn(s,m){if(s&1&&_(0,"nz-option",26),s&2){let a=m.$implicit;r("nzLabel",a.name)("nzValue",a.name)}}function Zn(s,m){if(s&1&&_(0,"nz-option",27),s&2){let a=m.$implicit;r("nzValue",a==null?null:a.id)("nzLabel",a==null?null:a.name)}}function Yn(s,m){if(s&1){let a=v();o(0,"nz-card",9)(1,"form",10),h("ngSubmit",function(){C(a);let t=z();return g(t.handleOk())}),o(2,"nz-row",11)(3,"nz-col",12)(4,"nz-form-item")(5,"nz-form-label",13),p(6,"Name"),l(),o(7,"nz-form-control",14)(8,"nz-select",15),h("ngModelChange",function(t){C(a);let n=z();return g(n.onExpenseNameChange(t))}),f(9,Kn,1,2,"nz-option",16),l()()()(),o(10,"nz-col",12)(11,"nz-form-item")(12,"nz-form-label",17),p(13,"Quantity"),l(),o(14,"nz-form-control",14)(15,"input",18),h("change",function(){C(a);let t=z();return g(t.onQuantityChange())}),l()()()()(),o(16,"nz-row",11)(17,"nz-col",12)(18,"nz-form-item")(19,"nz-form-label",13),p(20,"Unit Price"),l(),o(21,"nz-form-control",19)(22,"input",20),h("change",function(){C(a);let t=z();return g(t.onUnitPriceChange())}),l(),p(23," \xA0 "),l()()(),o(24,"nz-col",12)(25,"nz-form-item")(26,"nz-form-label",13),p(27,"Amount"),l(),o(28,"nz-form-control",19)(29,"div",0)(30,"span"),p(31),de(32,"currency"),l(),o(33,"label",21),p(34,"Paid"),l()()()()()(),o(35,"nz-row",11)(36,"nz-col",12)(37,"nz-form-item")(38,"nz-form-label",22),p(39,"Refered By"),l(),o(40,"nz-form-control",14)(41,"nz-select",23),f(42,Zn,1,2,"nz-option",24),l()()()()(),o(43,"nz-row",11)(44,"nz-col",12)(45,"nz-form-item")(46,"nz-form-label",13),p(47,"Payment Notes"),l(),o(48,"nz-form-control",19),_(49,"textarea",25),l()()()()()()}if(s&2){let a=z(),e=D(9),t,n;i(),r("formGroup",a.addExpenseForm),i(2),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(),r("nzDropdownRender",e),i(),r("ngForOf",a.vendorItems),i(),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(3),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(3),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(3),x(" ",ge(32,54,(t=a.addExpenseForm.get("amount"))==null?null:t.value," ")," "),i(2),r("nzChecked",(n=a.addExpenseForm.get("is_paid"))==null?null:n.value),i(3),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(2),r("ngForOf",a.users),i(2),r("nzMd",24)("nzSm",24)("nzXs",24),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24)}}function ei(s,m){if(s&1){let a=v();o(0,"div",28),_(1,"input",29,30),o(3,"a",31),h("click",function(){C(a);let t=D(2),n=z();return g(n.addItem(t))}),_(4,"span",32),p(5," Add item "),l()()}}function ti(s,m){if(s&1&&(o(0,"th",33),p(1),l()),s&2){let a=m.$implicit;r("nzSortFn",a.compare)("nzSortPriority",a.priority),i(),x(" ",a.title," ")}}function ni(s,m){if(s&1){let a=v();Je(0),o(1,"td"),p(2),de(3,"username"),l(),o(4,"td"),p(5),l(),o(6,"td"),p(7),l(),o(8,"td"),p(9),l(),o(10,"td"),p(11),l(),o(12,"td")(13,"label",36),V("ngModelChange",function(t){C(a);let n=z().$implicit,c=z();return k(c.editCache[n.id].data.is_paid,t)||(c.editCache[n.id].data.is_paid=t),g(t)}),l()(),o(14,"td")(15,"a",37),h("click",function(){C(a);let t=z().$implicit,n=z();return g(n.startEdit(t.id))}),p(16,"Edit"),l()(),Ke()}if(s&2){let a=z().$implicit,e=z();i(2),I(tt(3,8,a.refered_by)),i(3),fe("",a.is_general?"":"PO - "+a.purchase_id+" "," ",a.name,""),i(2),I(a.quantity),i(2),I(a.unit_price),i(2),I(a.amount),i(2),r("nzChecked",e.editCache[a.id].data.is_paid),M("ngModel",e.editCache[a.id].data.is_paid)}}function ii(s,m){if(s&1){let a=v();o(0,"span")(1,"input",44),V("ngModelChange",function(t){C(a);let n=z(2).$implicit,c=z();return k(c.editCache[n.id].data.name,t)||(c.editCache[n.id].data.name=t),g(t)}),l()()}if(s&2){let a=z(2).$implicit,e=z();i(),M("ngModel",e.editCache[a.id].data.name)}}function ai(s,m){if(s&1&&(o(0,"span"),p(1),l()),s&2){let a=z(2).$implicit,e=z();i(),I(e.editCache[a.id].data.name)}}function oi(s,m){if(s&1){let a=v();o(0,"span")(1,"input",45),h("ngModelChange",function(){C(a);let t=z(2).$implicit,n=z();return g(n.onItemQuantityChange(t.id))}),V("ngModelChange",function(t){C(a);let n=z(2).$implicit,c=z();return k(c.editCache[n.id].data.unit_price,t)||(c.editCache[n.id].data.unit_price=t),g(t)}),l()()}if(s&2){let a=z(2).$implicit,e=z();i(),M("ngModel",e.editCache[a.id].data.unit_price)}}function ri(s,m){if(s&1&&(o(0,"span"),p(1),l()),s&2){let a=z(2).$implicit,e=z();i(),I(e.editCache[a.id].data.unit_price)}}function si(s,m){if(s&1){let a=v();o(0,"td"),p(1),l(),o(2,"td"),f(3,ii,2,1,"span",38)(4,ai,2,1,"span",38),l(),o(5,"td")(6,"input",39),h("ngModelChange",function(){C(a);let t=z().$implicit,n=z();return g(n.onItemQuantityChange(t.id))}),V("ngModelChange",function(t){C(a);let n=z().$implicit,c=z();return k(c.editCache[n.id].data.quantity,t)||(c.editCache[n.id].data.quantity=t),g(t)}),l()(),o(7,"td"),f(8,oi,2,1,"span",38)(9,ri,2,1,"span",38),l(),o(10,"td")(11,"input",40),V("ngModelChange",function(t){C(a);let n=z().$implicit,c=z();return k(c.editCache[n.id].data.amount,t)||(c.editCache[n.id].data.amount=t),g(t)}),l()(),o(12,"td")(13,"label",41),V("ngModelChange",function(t){C(a);let n=z().$implicit,c=z();return k(c.editCache[n.id].data.is_paid,t)||(c.editCache[n.id].data.is_paid=t),g(t)}),l()(),o(14,"td")(15,"a",42),h("click",function(){C(a);let t=z().$implicit,n=z();return g(n.saveEdit(t.id))}),p(16,"Save"),l(),p(17," \xA0 "),o(18,"a",43),h("nzOnConfirm",function(){C(a);let t=z().$implicit,n=z();return g(n.cancelEdit(t.id))}),p(19,"Cancel"),l()()}if(s&2){let a=z().$implicit,e=z();i(),I(a.refered_by),i(2),r("ngIf",a.is_general),i(),r("ngIf",!a.is_general),i(2),M("ngModel",e.editCache[a.id].data.quantity),i(2),r("ngIf",a.is_general),i(),r("ngIf",!a.is_general),i(2),M("ngModel",e.editCache[a.id].data.amount),i(2),r("disabled",!a.is_general)("nzChecked",e.editCache[a.id].data.is_paid),M("ngModel",e.editCache[a.id].data.is_paid)}}function li(s,m){if(s&1&&(o(0,"tr"),f(1,ni,17,10,"ng-container",34)(2,si,20,10,"ng-template",null,35,T),l()),s&2){let a=m.$implicit,e=D(3),t=z();i(),r("ngIf",!(t.editCache[a.id]!=null&&t.editCache[a.id].edit))("ngIfElse",e)}}var Yt=(()=>{let m=class m{constructor(e,t,n){this.appService=e,this.userService=t,this.fb=n,this.vendorItems=[],this.listOfColumn=[{title:"Reference By",compare:(c,u)=>c.refered_by-u.refered_by,priority:3},{title:"Name",compare:(c,u)=>c.name.localeCompare(u.name),priority:!1},{title:"Quantity",compare:(c,u)=>c.quantity-u.quantity,priority:2},{title:"Unit Price",compare:(c,u)=>(c.unit_price||0)-(u.unit_price||0),priority:2},{title:"Amount",compare:(c,u)=>c.amount-u.amount,priority:2},{title:"Paid",compare:(c,u)=>(c.is_paid?1:0)-(u.is_paid?1:0),priority:2},{title:"Action",compare:(c,u)=>c.refered_by-u.refered_by,priority:3}],this.listOfData=[],this.visible=!1,this.isVisible=!1,this.isOkLoading=!1,this.index=0,this.editCache={},this.addExpenseForm=new J({id:new d(0),name:new d("",[ze.required]),is_general:new d(!0),quantity:new d(0,[ze.required]),amount:new d({value:0,disabled:!0}),refered_by:new d(0),purchase_id:new d(0),is_paid:new d(0),site:new d(this.site_id),note:new d,unit_price:new d(0,[ze.required])})}showModal(){this.isVisible=!0}handleOk(){return y(this,null,function*(){try{this.isOkLoading=!0,yield this.addExpense(),this.isVisible=!1,this.addExpenseForm.reset()}catch{}finally{this.isOkLoading=!1,this.populateExpenseData()}})}addExpense(){return y(this,null,function*(){this.subOrganizations=yield this.appService.saveSiteExpense(F(b({},this.addExpenseForm.getRawValue()),{site:this.site_id}))})}handleCancel(){this.isVisible=!1}ngOnInit(){this.populateExpenseData()}open(){this.visible=!0}close(e=!1){this.visible=!1,e&&this.populateExpenseData()}populateExpenseData(){return y(this,null,function*(){this.listOfData=yield this.appService.retrieveExpensesBySiteId(this.site_id),this.users=yield this.userService.getOrganizationUsers(),this.ExpenseRoles=yield this.appService.getRoles(),this.subOrganizations=yield this.appService.getSubOrganizations(),this.vendorItems=yield this.appService.getInventoryBySiteId(this.site_id),this.ExpenseRoles=this.ExpenseRoles.map(e=>({key:e.role_name,value:e.id})),this.subOrganizations=this.subOrganizations.map(e=>F(b({},e),{key:e.name,value:e.id})),this.updateEditCache()})}addItem(e){let t=e.value;this.vendorItems.some(n=>!t||n.name===t.trim())||(this.vendorItems=[...this.vendorItems,{name:e.value,isCustom:!0}],e.value="")}startEdit(e){this.editCache[e].edit=!0}cancelEdit(e){let t=this.listOfData.findIndex(n=>n.id===e);this.editCache[e]={data:b({},this.listOfData[t]),edit:!1}}saveEdit(e){return y(this,null,function*(){let t=this.listOfData.findIndex(n=>n.id===e);this.editCache[e].edit=!1,Object.assign(this.listOfData[t],this.editCache[e].data),yield this.appService.updateSiteExpense(this.editCache[e].data),this.populateExpenseData()})}updateEditCache(){this.listOfData.forEach(e=>{this.editCache[e.id]={edit:!1,data:b({},e)}})}onExpenseNameChange(e){let t=this.vendorItems.find(n=>n.name===e.trim());t.isCustom?(this.addExpenseForm.controls.is_general.setValue(!0),this.addExpenseForm.controls.is_paid.enable(),this.addExpenseForm.controls.unit_price.enable(),this.addExpenseForm.controls.is_paid.setValue(!1),this.addExpenseForm.controls.quantity.setValue(0),this.addExpenseForm.controls.amount.setValue(0),this.addExpenseForm.controls.purchase_id?.setValue(0),this.addExpenseForm.controls.unit_price?.setValue(0)):(this.addExpenseForm.controls.is_general.setValue(!1),this.addExpenseForm.controls.is_paid.setValue(!0),this.addExpenseForm.controls.quantity.setValue(0),this.addExpenseForm.controls.amount.setValue(0),this.addExpenseForm.controls.is_paid.disable(),this.addExpenseForm.controls.purchase_id?.setValue(t.purchase_id),this.addExpenseForm.controls.unit_price?.setValue(t.unit_price),this.addExpenseForm.controls.unit_price.disable())}onQuantityChange(){if(this.addExpenseForm.controls.is_general.value)this.onUnitPriceChange();else{let e=this.vendorItems.find(t=>t.name===this.addExpenseForm.controls.name.value);this.addExpenseForm.patchValue({amount:this.addExpenseForm.controls.quantity.value*parseFloat(e.unit_price)})}}onUnitPriceChange(){this.addExpenseForm.controls.is_general.value&&this.addExpenseForm.patchValue({amount:this.addExpenseForm.controls.quantity.value*this.addExpenseForm.controls.unit_price.value})}onItemQuantityChange(e){setTimeout(()=>{this.editCache[e].data.amount=this.editCache[e].data.quantity*(parseFloat(this.editCache[e].data.unit_price?.toString()||"0")||0)})}};m.\u0275fac=function(t){return new(t||m)(S(N),S(q),S(ee))},m.\u0275cmp=O({type:m,selectors:[["app-expenses"]],inputs:{site_id:"site_id"},decls:18,vars:6,consts:[[1,"flex","center","space-between"],["nz-button","","nzType","primary",3,"click"],["nzTitle","Add Expense",3,"nzVisible","nzOkDisabled","nzOkLoading","nzVisibleChange","nzOnCancel","nzOnOk"],["style","width:100%",4,"nzModalContent"],["renderTemplate",""],["nzShowPagination","false","nzTableLayout","fixed",3,"nzData"],["editRowTable","","sortTable",""],[3,"nzSortFn","nzSortPriority",4,"ngFor","ngForOf"],[4,"ngFor","ngForOf"],[2,"width","100%"],["nz-form","",3,"formGroup","ngSubmit"],["nzGutter","2",2,"margin-bottom","12px"],[3,"nzMd","nzSm","nzXs"],["nzRequired","","nzFor","name",3,"nzMd","nzSm","nzXs"],["nzErrorTip","The input is not valid date!",3,"nzSm","nzXs"],["formControlName","name","nzAllowClear","","nzPlaceHolder","Select item",1,"control","inputField",3,"nzDropdownRender","ngModelChange"],[3,"nzLabel","nzValue",4,"ngFor","ngForOf"],["nzRequired","","nzFor","quantity",3,"nzMd","nzSm","nzXs"],["nz-input","","formControlName","quantity",1,"control","inputField",3,"change"],["nzErrorTip","The input is not valid date!",1,"flex","space-between","center",3,"nzSm","nzXs"],["nz-input","","formControlName","unit_price",1,"control","inputField",3,"change"],["nz-checkbox","","formControlName","is_paid",3,"nzChecked"],["nzFor","refered_by",3,"nzMd","nzSm","nzXs"],["id","reports_to","formControlName","refered_by","placeholder","Select user",1,"control","inputField"],[3,"nzValue","nzLabel",4,"ngFor","ngForOf"],["nz-input","","formControlName","note",1,"control","inputField"],[3,"nzLabel","nzValue"],[3,"nzValue","nzLabel"],[1,"container"],["type","text","nz-input",""],["inputElement",""],[1,"add-item",3,"click"],["nz-icon","","nzType","plus"],[3,"nzSortFn","nzSortPriority"],[4,"ngIf","ngIfElse"],["editTemplate",""],["nz-checkbox","","disabled","",3,"nzChecked","ngModel","ngModelChange"],[3,"click"],[4,"ngIf"],["nz-input","","id","quantity",3,"ngModel","ngModelChange"],["nz-input","","disabled","","id","unit_price",3,"ngModel","ngModelChange"],["nz-checkbox","",3,"disabled","nzChecked","ngModel","ngModelChange"],[1,"save",3,"click"],["nz-popconfirm","","nzPopconfirmTitle","Sure to cancel?",3,"nzOnConfirm"],["nz-input","",3,"ngModel","ngModelChange"],["nz-input","","id","unit_price",3,"ngModel","ngModelChange"]],template:function(t,n){if(t&1&&(o(0,"div",0)(1,"h3"),p(2,"Expense"),l(),o(3,"button",1),h("click",function(){return n.showModal()}),o(4,"span"),p(5,"Add Expense"),l()()(),o(6,"nz-modal",2),V("nzVisibleChange",function(u){return k(n.isVisible,u)||(n.isVisible=u),u}),h("nzOnCancel",function(){return n.handleCancel()})("nzOnOk",function(){return n.handleOk()}),f(7,Yn,50,57,"nz-card",3),l(),f(8,ei,6,0,"ng-template",null,4,T),o(10,"nz-table",5,6)(13,"thead")(14,"tr"),f(15,ti,2,3,"th",7),l()(),o(16,"tbody"),f(17,li,4,2,"tr",8),l()()),t&2){let c=D(12);i(6),M("nzVisible",n.isVisible),r("nzOkDisabled",n.addExpenseForm.invalid)("nzOkLoading",n.isOkLoading),i(4),r("nzData",n.listOfData),i(5),r("ngForOf",n.listOfColumn),i(2),r("ngForOf",c.data)}},dependencies:[P,W,A,L,R,ne,ke,X,ae,ie,re,oe,le,se,te,Se,ye,Ct,ot,rt,G,me,j,ce,pe,B,U,K,$,Q,H,Z,Y,Ie,Te,Le]});let s=m;return s})();function ci(s,m){if(s&1){let a=v();o(0,"nz-card",9)(1,"form",10),h("ngSubmit",function(){C(a);let t=z();return g(t.handleOk())}),o(2,"nz-row",11)(3,"nz-col",12)(4,"nz-form-item")(5,"nz-form-label",13),p(6,"Name"),l(),o(7,"nz-form-control",14),_(8,"input",15),l()()(),o(9,"nz-col",12)(10,"nz-form-item")(11,"nz-form-label",16),p(12,"Amount"),l(),o(13,"nz-form-control",14),_(14,"input",17),l()()(),o(15,"nz-col",12)(16,"nz-form-item")(17,"nz-form-label",13),p(18," Is Paid"),l(),o(19,"nz-form-control",18)(20,"label",19),p(21,"Paid"),l()()()()(),o(22,"nz-row",11)(23,"nz-col",12)(24,"nz-form-item")(25,"nz-form-label",13),p(26,"Payment Notes"),l(),o(27,"nz-form-control",18),_(28,"textarea",20),l()()()()()()}if(s&2){let a=z(),e;i(),r("formGroup",a.addOwnerPaymentForm),i(2),r("nzMd",10)("nzSm",24)("nzXs",24),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(2),r("nzMd",10)("nzSm",16)("nzXs",16),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(2),r("nzMd",4)("nzSm",8)("nzXs",8),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(),r("nzChecked",(e=a.addOwnerPaymentForm.get("is_paid"))==null?null:e.value),i(3),r("nzMd",24)("nzSm",24)("nzXs",24),i(2),r("nzMd",8)("nzSm",24)("nzXs",24),i(2),r("nzSm",14)("nzXs",24)}}function pi(s,m){if(s&1){let a=v();o(0,"div",21),_(1,"input",22,23),o(3,"a",24),h("click",function(){C(a);let t=D(2),n=z();return g(n.addItem(t))}),_(4,"span",25),p(5," Add item "),l()()}}function di(s,m){if(s&1&&(o(0,"th",26),p(1),l()),s&2){let a=m.$implicit;r("nzSortFn",a.compare)("nzSortPriority",a.priority),i(),x(" ",a.title," ")}}function zi(s,m){if(s&1){let a=v();o(0,"a",31),h("click",function(){C(a);let t=z().$implicit,n=z();return g(n.startEdit(t.id))}),p(1,"Edit"),l()}}function ui(s,m){if(s&1){let a=v();o(0,"a",32),h("click",function(){C(a);let t=z().$implicit,n=z();return g(n.saveEdit(t.id))}),p(1,"Save"),l()}}function _i(s,m){if(s&1){let a=v();o(0,"a",33),h("nzOnConfirm",function(){C(a);let t=z().$implicit,n=z();return g(n.cancelEdit(t.id))}),p(1,"Cancel"),l()}}function fi(s,m){if(s&1){let a=v();o(0,"tr")(1,"td"),p(2),l(),o(3,"td"),p(4),l(),o(5,"td")(6,"label",27),V("ngModelChange",function(t){let c=C(a).$implicit,u=z();return k(u.editCache[c.id].data.is_paid,t)||(u.editCache[c.id].data.is_paid=t),g(t)}),l()(),o(7,"td"),f(8,zi,2,0,"a",28)(9,ui,2,0,"a",29),p(10," \xA0 "),f(11,_i,2,0,"a",30),l()()}if(s&2){let a=m.$implicit,e=z();i(2),x(" ",a.name,""),i(2),I(a.amount),i(2),r("disabled",!(e.editCache[a.id]!=null&&e.editCache[a.id].edit))("nzChecked",e.editCache[a.id].data.is_paid),M("ngModel",e.editCache[a.id].data.is_paid),i(2),r("ngIf",!(e.editCache[a.id]!=null&&e.editCache[a.id].edit)),i(),r("ngIf",e.editCache[a.id]==null?null:e.editCache[a.id].edit),i(2),r("ngIf",e.editCache[a.id]==null?null:e.editCache[a.id].edit)}}var en=(()=>{let m=class m{constructor(e,t,n){this.appService=e,this.userService=t,this.fb=n,this.vendorItems=[],this.listOfColumn=[{title:"Name",compare:(c,u)=>c.name.localeCompare(u.name),priority:!1},{title:"Amount",compare:(c,u)=>c.amount-u.amount,priority:2},{title:"Paid",compare:(c,u)=>(c.is_paid?1:0)-(u.is_paid?1:0),priority:2},{title:"Action",compare:(c,u)=>c.amount-u.amount,priority:3}],this.listOfData=[],this.visible=!1,this.isVisible=!1,this.isOkLoading=!1,this.index=0,this.editCache={},this.addOwnerPaymentForm=new J({id:new d(0),name:new d("",[ze.required]),amount:new d(0,[ze.required]),is_paid:new d(0),site:new d(this.site_id),note:new d})}showModal(){this.isVisible=!0}handleOk(){return y(this,null,function*(){try{this.isOkLoading=!0,yield this.addOwnerPayment(),this.isVisible=!1,this.addOwnerPaymentForm.reset()}catch{}finally{this.isOkLoading=!1,this.populateOwnerPaymentData()}})}addOwnerPayment(){return y(this,null,function*(){this.subOrganizations=yield this.appService.saveSiteOwnerPayment(F(b({},this.addOwnerPaymentForm.getRawValue()),{site:this.site_id}))})}handleCancel(){this.isVisible=!1}ngOnInit(){this.populateOwnerPaymentData()}open(){this.visible=!0}close(e=!1){this.visible=!1,e&&this.populateOwnerPaymentData()}populateOwnerPaymentData(){return y(this,null,function*(){this.listOfData=yield this.appService.retrieveOwnerPaymentsBySiteId(this.site_id),this.users=yield this.userService.getOrganizationUsers(),this.OwnerPaymentRoles=yield this.appService.getRoles(),this.subOrganizations=yield this.appService.getSubOrganizations(),this.vendorItems=yield this.appService.getInventoryBySiteId(this.site_id),this.OwnerPaymentRoles=this.OwnerPaymentRoles.map(e=>({key:e.role_name,value:e.id})),this.subOrganizations=this.subOrganizations.map(e=>F(b({},e),{key:e.name,value:e.id})),this.updateEditCache()})}addItem(e){let t=e.value;this.vendorItems.some(n=>!t||n.name===t.trim())||(this.vendorItems=[...this.vendorItems,{name:e.value,isCustom:!0}],e.value="")}startEdit(e){this.editCache[e].edit=!0}cancelEdit(e){let t=this.listOfData.findIndex(n=>n.id===e);this.editCache[e]={data:b({},this.listOfData[t]),edit:!1}}saveEdit(e){return y(this,null,function*(){let t=this.listOfData.findIndex(n=>n.id===e);this.editCache[e].edit=!1,Object.assign(this.listOfData[t],this.editCache[e].data),yield this.appService.updateSiteOwnerPayment(this.editCache[e].data),this.populateOwnerPaymentData()})}updateEditCache(){this.listOfData.forEach(e=>{this.editCache[e.id]={edit:!1,data:b({},e)}})}};m.\u0275fac=function(t){return new(t||m)(S(N),S(q),S(ee))},m.\u0275cmp=O({type:m,selectors:[["app-owner-payments"]],inputs:{site_id:"site_id"},decls:18,vars:6,consts:[[1,"flex","center","space-between"],["nz-button","","nzType","primary",3,"click"],["nzTitle","Add Owner Payment",3,"nzVisible","nzOkDisabled","nzOkLoading","nzVisibleChange","nzOnCancel","nzOnOk"],["style","width:100%",4,"nzModalContent"],["renderTemplate",""],["nzShowPagination","false","nzTableLayout","fixed",3,"nzData"],["editRowTable","","sortTable",""],[3,"nzSortFn","nzSortPriority",4,"ngFor","ngForOf"],[4,"ngFor","ngForOf"],[2,"width","100%"],["nz-form","",3,"formGroup","ngSubmit"],["nzGutter","2",2,"margin-bottom","12px"],[3,"nzMd","nzSm","nzXs"],["nzRequired","","nzFor","name",3,"nzMd","nzSm","nzXs"],["nzErrorTip","The input is not valid date!",3,"nzSm","nzXs"],["nz-input","","formControlName","name",1,"control","inputField"],["nzRequired","","nzFor","amount",3,"nzMd","nzSm","nzXs"],["nz-input","","formControlName","amount",1,"control","inputField"],["nzErrorTip","The input is not valid date!",1,"flex","space-between","center",3,"nzSm","nzXs"],["nz-checkbox","","formControlName","is_paid",3,"nzChecked"],["nz-input","","formControlName","note",1,"control","inputField"],[1,"container"],["type","text","nz-input",""],["inputElement",""],[1,"add-item",3,"click"],["nz-icon","","nzType","plus"],[3,"nzSortFn","nzSortPriority"],["nz-checkbox","",3,"disabled","nzChecked","ngModel","ngModelChange"],[3,"click",4,"ngIf"],["class","save",3,"click",4,"ngIf"],["nz-popconfirm","","nzPopconfirmTitle","Sure to cancel?",3,"nzOnConfirm",4,"ngIf"],[3,"click"],[1,"save",3,"click"],["nz-popconfirm","","nzPopconfirmTitle","Sure to cancel?",3,"nzOnConfirm"]],template:function(t,n){if(t&1&&(o(0,"div",0)(1,"h3"),p(2,"Owner Payment"),l(),o(3,"button",1),h("click",function(){return n.showModal()}),o(4,"span"),p(5,"Add Owner Payment"),l()()(),o(6,"nz-modal",2),V("nzVisibleChange",function(u){return k(n.isVisible,u)||(n.isVisible=u),u}),h("nzOnCancel",function(){return n.handleCancel()})("nzOnOk",function(){return n.handleOk()}),f(7,ci,29,34,"nz-card",3),l(),f(8,pi,6,0,"ng-template",null,4,T),o(10,"nz-table",5,6)(13,"thead")(14,"tr"),f(15,di,2,3,"th",7),l()(),o(16,"tbody"),f(17,fi,12,8,"tr",8),l()()),t&2){let c=D(12);i(6),M("nzVisible",n.isVisible),r("nzOkDisabled",n.addOwnerPaymentForm.invalid)("nzOkLoading",n.isOkLoading),i(4),r("nzData",n.listOfData),i(5),r("ngForOf",n.listOfColumn),i(2),r("ngForOf",c.data)}},dependencies:[P,W,A,L,R,ne,ke,X,ae,ie,re,oe,le,se,te,Se,ye,Ct,G,me,j,ce,pe,B,U,K,$,Q,H,Z,Y,Ie]});let s=m;return s})();function Ci(s,m){if(s&1&&(o(0,"th",5),p(1),l()),s&2){let a=m.$implicit;r("nzSortFn",a.compare)("nzSortPriority",a.priority)("nzWidth",a.width),i(),x(" ",a.title," ")}}var gi=s=>["contract",s];function yi(s,m){if(s&1&&(o(0,"tr")(1,"td"),p(2),de(3,"username"),l(),o(4,"td"),p(5),l(),o(6,"td"),p(7),de(8,"currency"),l(),o(9,"td")(10,"a",6),p(11),l()()()),s&2){let a=m.$implicit;i(2),x(" ",tt(3,5,a.contractor),""),i(3),x(" ",a.subject,""),i(2),x(" ",ge(8,7,a.amount," "),""),i(3),r("routerLink",Ne(10,gi,a.id)),i(),x("CR-",a.id,"")}}var tn=(()=>{let m=class m{constructor(e){this.appService=e,this.listOfColumn=[{title:"Contractor",compare:(t,n)=>t.contractor-n.contractor,priority:1,with:"30%"},{title:"Title",compare:(t,n)=>t.subject.localeCompare(n.subject),priority:2,with:"30%"},{title:"Amount",compare:(t,n)=>t.amount-n.amount,priority:2,with:"20%"},{title:"+Work-Payment",compare:(t,n)=>t.amount-n.amount,priority:3,with:"20%"}],this.listOfData=[],this.visible=!1}ngOnInit(){this.populateContractPaymentData()}open(e){this.visible=!0}populateContractPaymentData(){return y(this,null,function*(){this.listOfData=yield this.appService.retrieveContractPaymentsBySiteId(this.site_id)})}};m.\u0275fac=function(t){return new(t||m)(S(N))},m.\u0275cmp=O({type:m,selectors:[["app-contractor-payments"]],inputs:{site_id:"site_id"},decls:11,vars:3,consts:[[1,"flex","center","space-between"],["nzShowPagination","false","nzTableLayout","fixed",3,"nzData"],["editRowTable","","sortTable",""],[3,"nzSortFn","nzSortPriority","nzWidth",4,"ngFor","ngForOf"],[4,"ngFor","ngForOf"],[3,"nzSortFn","nzSortPriority","nzWidth"],["href","",3,"routerLink"]],template:function(t,n){if(t&1&&(o(0,"div",0)(1,"h3"),p(2,"Contractors Payments"),l()(),o(3,"nz-table",1,2)(6,"thead")(7,"tr"),f(8,Ci,2,4,"th",3),l()(),o(9,"tbody"),f(10,yi,12,12,"tr",4),l()()),t&2){let c=D(5);i(3),r("nzData",n.listOfData),i(5),r("ngForOf",n.listOfColumn),i(2),r("ngForOf",c.data)}},dependencies:[P,Fe,G,me,j,ce,pe,B,U,Te,Le]});let s=m;return s})();var vi=["content"];function xi(s,m){if(s&1){let a=v();o(0,"div",32)(1,"span")(2,"h4"),p(3),l()(),o(4,"span")(5,"button",33),h("click",function(){C(a);let t=z();return g(t.generatePDF())}),_(6,"span",34),l(),o(7,"button",35),_(8,"span",36),l()()()}if(s&2){let a=z(),e;i(3),fe(" ",((e=a.siteDetails.get("id"))==null?null:e.value)||"New"," - / ",(e=a.siteDetails.get("name"))==null?null:e.value," ")}}function wi(s,m){if(s&1){let a=v();o(0,"button",37),h("click",function(){C(a);let t=z();return g(t.cancelPaymentDetails())}),p(1,"Cancel"),l()}}function bi(s,m){if(s&1){let a=v();o(0,"button",38),h("click",function(){C(a);let t=z();return g(t.submitRequest())}),p(1,"Submit"),l()}}function Di(s,m){if(s&1){let a=v();o(0,"button",38),h("click",function(){C(a);let t=z();return g(t.approveDetails())}),p(1,"Approve Site"),l()}}function Ei(s,m){if(s&1&&(p(0),_(1,"span",39)),s&2){let a=m.$implicit;z();let e=D(4);x(" ",a," "),i(),r("nzRotate",e.nzActive?90:-90)}}function Oi(s,m){if(s&1&&(o(0,"div",40)(1,"nz-row",41)(2,"nz-col",9)(3,"nz-card",5),_(4,"app-expenses",42),l()(),o(5,"nz-col",9)(6,"nz-card",5),_(7,"app-owner-payments",42),l(),o(8,"nz-card",43),_(9,"app-contractor-payments",42),l()()()()),s&2){let a=z();i(2),r("nzMd",16)("nzSm",24)("nzXs",24),i(2),r("site_id",a.site_id),i(),r("nzMd",8)("nzSm",24)("nzXs",24),i(2),r("site_id",a.site_id),i(2),r("site_id",a.site_id)}}var an=(()=>{let m=class m{constructor(e,t,n,c,u,w,E,we){this.appService=e,this.route=t,this.userService=n,this.fb=c,this.notification=u,this.router=w,this.msg=E,this.modal=we,this.vendors=[],this.isActive=!1,this.vendorItems=[],this.discountTotal=0,this.siteTotal=0,this.loading=!1,this.siteStates=yt,this.stateNames=St,this.site_id=0,this.listOfData=[],this.defaultItemValues={id:0,name:"",qty:0,discount:0,total:0,date_created:new Date,isCustom:!1,unit_price:0},this.siteDetails=new J({id:new d,name:new d,budget:new d,owner:new d,contact_no:new d,state:new d(this.siteStates.Draft),address:new d,site_start_date:new d(new Date),site_end_date:new d(new Date),details:new d,created_by:new d(0),total:new d(0),organization:new d(0),subOrganization:new d(0)}),this.beforeUpload=(_e,sn)=>new $e(he=>{let Re=_e.type==="image/jpeg"||_e.type==="image/png";if(!Re){this.msg.error("You can only upload JPG file!"),he.complete();return}let Ae=_e.size/1024/1024<2;if(!Ae){this.msg.error("Image must smaller than 2MB!"),he.complete();return}he.next(Re&&Ae),he.complete()}),this.siteDetails=this.fb.group({id:new d,name:new d,budget:new d,owner:new d,contact_no:new d,state:new d(this.siteStates.Draft),address:new d,site_start_date:new d(new Date),site_end_date:new d(new Date),details:new d,created_by:new d(0),total:new d(0),organization:new d(0),subOrganization:new d(0)})}submitForm(){}ngOnInit(){this.loadAndUsers(),this.setSitesData(),this.route.paramMap.subscribe(e=>{e.get("siteId")||(this.siteDetails.reset({state:this.siteStates.Draft,id:0}),this.siteDetails.enable(),this.siteDetails.updateValueAndValidity()),this.siteDetails.controls.id.setValue(e.get("siteId")!=="new"?e.get("siteId"):0),this.site_id=this.siteDetails.controls.id.value,this.setSiteDetails()})}ngOnDestroy(){}setSitesData(){return y(this,null,function*(){let e=yield this.appService.getAndSetSites(),t=e&&e.length?e.map(n=>b({label:n.name},n)):[];this.sites=[...t]})}setSiteDetails(){return y(this,null,function*(){this.loading=!0,this.siteDetails.controls.id.value&&(yield this.getExistingsite()),this.disableAndEnableSpecificControls(),this.loading=!1})}getExistingsite(){return y(this,null,function*(){let e=yield this.appService.retireveSiteById(this.siteDetails.controls.id.value);e&&this.siteDetails.patchValue({id:e.id,state:e.state,created_by:e.created_by,total:e.total,organization:e.organization_id,subOrganization:e.sub_organization_id,owner:e.owner,site_start_date:e.site_start_date,site_end_date:e.site_end_date,name:e.name,budget:e.budget,contact_no:e.contact_no,address:e.address,details:e.details}),this.previoussiteDetails=this.siteDetails.getRawValue()})}loadAndUsers(){return y(this,null,function*(){this.listOfData=yield this.userService.getOrganizationUsers()})}submitRequest(){return y(this,null,function*(){let e=yield this.appService.createSite(F(b({},this.siteDetails.value),{state:this.siteStates.PendingApproval}));e&&this.notification.create("success","site Order - "+e.id,"site order submitted successfly. Please check for invoice and update later").onClose.subscribe(t=>{this.router.navigate(["/"])})})}cancelPaymentDetails(){return y(this,null,function*(){})}approveDetails(){return y(this,null,function*(){let e=this.appService.findObjectDifferences(this.previoussiteDetails,this.siteDetails.getRawValue());console.log(e);let t=b({id:this.previoussiteDetails.id},e);(yield this.appService.updateSiteRequest(F(b({},t),{state:this.siteStates.Approved})))&&this.notification.create("success","site Order - "+this.previoussiteDetails.id,"site order invoice submitted successfly. Please proceed next for payment details").onClose.subscribe(c=>{this.router.navigate(["/"])})})}printCard(){let e=this.content.nativeElement.innerHTML,t=window.open("","_blank","top=0,left=0,height=100%,width=auto");t&&(t.document.open(),t.document.write(`
      <html>
        <head>
          <title>Print</title>
          <style>
            /* Define print styles here */
          </style>
        </head>
        <body onload="window.print();window.close()">
          ${e}
        </body>
      </html>
    `),t.print())}generatePDF(){let e=this.content.nativeElement;(0,nn.default)(e).then(t=>{let n=t.toDataURL("image/png")})}disableAndEnableSpecificControls(){let e=this.siteDetails.get("state");e&&e.value!==this.siteStates.Draft&&(console.log(this.siteDetails),Object.keys(this.siteDetails.controls).forEach(t=>{let n=this.siteDetails.get(t);n&&(t!=="attachment"&&t!=="terms"&&e.value===this.siteStates.PendingApproval||e.value===this.siteStates.Completed)&&n.disable()}),console.log(this.siteDetails),this.siteDetails.updateValueAndValidity())}getBase64(e,t){let n=new FileReader;n.addEventListener("load",()=>t(n.result.toString())),n.readAsDataURL(e)}handleChange(e){this.getBase64(e.file.originFileObj,t=>{this.loading=!1})}};m.\u0275fac=function(t){return new(t||m)(S(N),S(it),S(q),S(ee),S(ht),S(at),S(_t),S(ft))},m.\u0275cmp=O({type:m,selectors:[["app-site"]],viewQuery:function(t,n){if(t&1&&Ze(vi,5),t&2){let c;Ye(c=et())&&(n.content=c.first)}},decls:73,vars:74,consts:[["renderHome",""],["nzAccordion",""],["nzExpandedIcon","double-right",3,"nzHeader","nzActive","nzDisabled"],["p",""],["id","print-section",1,"purchase-request"],[2,"width","100%"],["nz-form","",3,"formGroup","ngSubmit"],["content",""],["nzGutter","2",2,"margin-bottom","12px"],[3,"nzMd","nzSm","nzXs"],["nzRequired","","nzFor","name",3,"nzMd","nzSm","nzXs"],["nzErrorTip","The input is not valid date!",3,"nzSm","nzXs"],["nz-input","","formControlName","name",1,"control","inputField"],["nzRequired","","nzFor","budget",3,"nzMd","nzSm","nzXs"],["z-input","","formControlName","budget",1,"control","inputField"],["nzRequired","","nzFor","owner",3,"nzMd","nzSm","nzXs"],["nz-input","","formControlName","owner",1,"control","inputField"],["nzRequired","","nzFor","contact_no",3,"nzMd","nzSm","nzXs"],["nz-input","","formControlName","contact_no",1,"control","inputField"],["nzRequired","","nzFor","address",3,"nzMd","nzSm","nzXs"],["nz-input","","formControlName","address",1,"control","inputField",3,"rows"],["nzRequired","","nzFor","site_start_date",3,"nzMd","nzSm","nzXs"],["formControlName","site_start_date",1,"control","inputField"],["nzRequired","","nzFor","site_end_date",3,"nzMd","nzSm","nzXs"],["formControlName","site_end_date",1,"control","inputField"],["nzRequired","","nzFor","details",3,"nzMd","nzSm","nzXs"],["nz-input","","formControlName","details",1,"control","inputField",3,"rows"],[1,"flex","space-between"],["nz-button","","nzType","primary","nzDanger","","style","margin-bottom: 12px;float: right;",3,"click",4,"ngIf"],["nz-button","","nzType","primary","style","margin-bottom: 12px;float: right;",3,"click",4,"ngIf"],["expandedIcon",""],["style","margin-top: 12px;",4,"ngIf"],[1,"detailBar-collapsible"],["nz-button","","nzType","primary",3,"click"],["nz-icon","","nzType","download"],["nz-button","","nzType","primary","printSectionId","print-section","ngxPrint","","printTitle","MyTitle",2,"margin-left","12px"],["nz-icon","","nzType","printer","nzTheme","outline"],["nz-button","","nzType","primary","nzDanger","",2,"margin-bottom","12px","float","right",3,"click"],["nz-button","","nzType","primary",2,"margin-bottom","12px","float","right",3,"click"],["nz-icon","","nzType","caret-right",1,"ant-collapse-arrow",3,"nzRotate"],[2,"margin-top","12px"],["nzGutter","4",2,"margin-bottom","12px"],[3,"site_id"],[2,"width","100%","margin-top","4px"]],template:function(t,n){if(t&1&&(f(0,xi,9,2,"ng-template",null,0,T),o(2,"nz-collapse",1)(3,"nz-collapse-panel",2,3)(5,"div",4)(6,"nz-card",5)(7,"form",6),h("ngSubmit",function(){return n.submitForm()}),o(8,"div",null,7)(10,"nz-row",8)(11,"nz-col",9)(12,"nz-form-item")(13,"nz-form-label",10),p(14," Name"),l(),o(15,"nz-form-control",11),_(16,"input",12),l()()(),o(17,"nz-col",9)(18,"nz-form-item")(19,"nz-form-label",13),p(20,"budget"),l(),o(21,"nz-form-control",11),_(22,"input",14),l()()()(),o(23,"nz-row",8)(24,"nz-col",9)(25,"nz-form-item")(26,"nz-form-label",15),p(27,"owner"),l(),o(28,"nz-form-control",11),_(29,"input",16),l()()(),o(30,"nz-col",9)(31,"nz-form-item")(32,"nz-form-label",17),p(33,"Contact No"),l(),o(34,"nz-form-control",11),_(35,"input",18),l()()()(),o(36,"nz-row",8)(37,"nz-col",9)(38,"nz-form-item")(39,"nz-form-label",19),p(40," Address"),l(),o(41,"nz-form-control",11),_(42,"textarea",20),l()()()(),o(43,"nz-row",8)(44,"nz-col",9)(45,"nz-form-item")(46,"nz-form-label",21),p(47,"site_start_date"),l(),o(48,"nz-form-control",11),_(49,"nz-date-picker",22),l()()(),o(50,"nz-col",9)(51,"nz-form-item")(52,"nz-form-label",23),p(53,"site_end_date"),l(),o(54,"nz-form-control",11),_(55,"nz-date-picker",24),l()()()(),o(56,"nz-row",8)(57,"nz-col",9)(58,"nz-form-item")(59,"nz-form-label",25),p(60," Contract Details "),l(),o(61,"nz-form-control",11)(62,"textarea",26),p(63,"                        "),l()()()()()(),o(64,"span",27)(65,"span"),f(66,wi,2,0,"button",28),l(),o(67,"span"),f(68,bi,2,0,"button",29)(69,Di,2,0,"button",29),l()()()()(),f(70,Ei,2,2,"ng-template",null,30,T),l()(),f(72,Oi,10,9,"div",31)),t&2){let c=D(1),u,w,E;i(3),r("nzHeader",c)("nzActive",n.isActive||((u=n.siteDetails.get("state"))==null?null:u.value)!==n.siteStates.Approved&&((u=n.siteDetails.get("state"))==null?null:u.value)!==n.siteStates.Completed)("nzDisabled",((w=n.siteDetails.get("state"))==null?null:w.value)!==n.siteStates.Approved&&((w=n.siteDetails.get("state"))==null?null:w.value)!==n.siteStates.Completed),i(4),r("formGroup",n.siteDetails),i(4),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(2),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(3),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(2),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(3),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(),r("rows",2),i(2),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(2),r("nzMd",12)("nzSm",24)("nzXs",12),i(2),r("nzMd",8)("nzSm",24)("nzXs",12),i(2),r("nzSm",14)("nzXs",24),i(3),r("nzMd",24)("nzSm",24)("nzXs",24),i(2),r("nzMd",4)("nzSm",24)("nzXs",24),i(2),r("nzSm",20)("nzXs",24),i(),r("rows",6),i(4),r("ngIf",n.siteDetails.controls.state.value==n.siteStates.PendingApproval),i(2),r("ngIf",n.siteDetails.controls.state.value==n.siteStates.Draft),i(),r("ngIf",n.siteDetails.controls.state.value==n.siteStates.PendingApproval),i(3),r("ngIf",((E=n.siteDetails.get("state"))==null?null:E.value)===n.siteStates.Approved)}},dependencies:[W,A,L,R,ne,lt,st,X,Me,ae,ie,re,oe,le,se,te,K,$,Q,H,Z,Y,Yt,en,tn],styles:[".ant-collapse-arrow{margin-top:10px}"]});let s=m;return s})();var Ni=[{path:"",component:Gt,data:{name:"All Sites"}},{path:":siteId",component:an,data:{name:"Site"}},{path:":siteId/contract/:contractId",component:Kt,data:{name:"Create Contract"}}],on=(()=>{let m=class m{};m.\u0275fac=function(t){return new(t||m)},m.\u0275mod=Qe({type:m}),m.\u0275inj=He({imports:[wt.forChild(Ni),wt]});let s=m;return s})();var rn=Ft,Ti=Object.keys(rn).map(s=>rn[s]),ka=(()=>{let m=class m{};m.\u0275fac=function(t){return new(t||m)},m.\u0275mod=Qe({type:m}),m.\u0275inj=He({providers:[{provide:Pt,useValue:Vt},{provide:It,useValue:Ti},Le],imports:[Ot,on,qt,kt,Mt]});let s=m;return s})();export{ka as SitesModule};
